# Advanced workflow with multiple jobs and dependencies
name: Advanced CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'
  APP_NAME: 'python-calculator'

jobs:
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-lint-${{ hashFiles('**/requirements.txt') }}

      - name: Install tools
        run: |
          pip install flake8 black isort

      - name: Run black
        run: black --check app.py test_app.py

      - name: Run isort
        run: isort --check-only app.py test_app.py

      - name: Run flake8
        run: flake8 app.py test_app.py

  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-test-${{ hashFiles('**/requirements.txt') }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests with coverage
        run: |
          pytest test_app.py -v --cov=app --cov-report=term-missing --cov-report=html

      - name: Upload coverage reports
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: htmlcov/

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: pip install bandit safety

      - name: Run bandit
        run: bandit -r app.py -f json -o bandit-report.json || true

      - name: Check dependencies
        run: safety check --json || true

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build artifact
        run: |
          mkdir -p dist
          cp app.py dist/
          cp test_app.py dist/
          cp requirements.txt dist/
          echo "Build: $(date)" > dist/BUILD_METADATA.txt
          echo "Commit: ${{ github.sha }}" >> dist/BUILD_METADATA.txt

      - name: Upload to artifact repository
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.APP_NAME }}-build
          path: dist/
          retention-days: 30

      - name: Notify on success
        run: |
          echo "âœ… Pipeline completed successfully!"
          echo "Build artifact: ${{ env.APP_NAME }}-build"
